{% extends '../base.html' %}
{% load math_filters %}

{% block title %}Analytics - Finance Flow{% endblock %}

{% block content %}
<!-- Content Header -->
<div class="content-header">
    <h1 class="page-title">Analytics Dashboard</h1>
    <div class="header-actions">
        <button class="search-btn" title="Search">
            <i class="bi bi-search"></i>
        </button>
        <button class="notification-btn" title="Notifications">
            <i class="bi bi-bell"></i>
        </button>
        <div class="user-profile">
            <div class="user-avatar">{{ user.name|first|upper }}</div>
            <div class="user-name">{{ user.name }}</div>
        </div>
    </div>
</div>

<!-- Content Body -->
<div class="content-body">
    <!-- Analytics Overview Cards -->
    <div class="stats-grid mb-4">
        <div class="stat-card income fade-in-up stagger-1">
            <div class="stat-header">
                <div class="stat-icon income">
                    <i class="bi bi-graph-up"></i>
                </div>
                <div class="stat-change positive">
                    <i class="bi bi-arrow-up"></i>
                    {% if total_income and previous_income and previous_income > 0 %}
                        {{ total_income|percentage_change:previous_income|floatformat:1 }}%
                    {% else %}
                        0.0%
                    {% endif %}
                </div>
            </div>
            <div class="stat-value">₹{{ total_income|default:"0" }}</div>
            <div class="stat-label">Total Income</div>
            <div class="stat-comparison">
                {% if total_income and previous_income %}
                    {% if total_income > previous_income %}+{% endif %}₹{{ total_income|subtract:previous_income }} vs last month
                {% else %}
                    No previous data
                {% endif %}
            </div>
        </div>

        <div class="stat-card expense fade-in-up stagger-2">
            <div class="stat-header">
                <div class="stat-icon expense">
                    <i class="bi bi-graph-down"></i>
                </div>
                <div class="stat-change negative">
                    <i class="bi bi-arrow-down"></i>
                    {% if total_expenses and previous_expenses and previous_expenses > 0 %}
                        {{ total_expenses|percentage_change:previous_expenses|floatformat:1 }}%
                    {% else %}
                        0.0%
                    {% endif %}
                </div>
            </div>
            <div class="stat-value">₹{{ total_expenses|default:"0" }}</div>
            <div class="stat-label">Total Expenses</div>
            <div class="stat-comparison">
                {% if total_expenses and previous_expenses %}
                    {% if total_expenses < previous_expenses %}-{% endif %}₹{{ total_expenses|subtract:previous_expenses }} vs last month
                {% else %}
                    No previous data
                {% endif %}
            </div>
        </div>

        <div class="stat-card balance fade-in-up stagger-3">
            <div class="stat-header">
                <div class="stat-icon balance">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div class="stat-change positive">
                    <i class="bi bi-arrow-up"></i>
                    {% if balance and previous_balance and previous_balance > 0 %}
                        {{ balance|percentage_change:previous_balance|floatformat:1 }}%
                    {% else %}
                        0.0%
                    {% endif %}
                </div>
            </div>
            <div class="stat-value">₹{{ balance|default:"0" }}</div>
            <div class="stat-label">Net Savings</div>
            <div class="stat-comparison">
                {% if balance and previous_balance %}
                    {% if balance > previous_balance %}+{% endif %}₹{{ balance|subtract:previous_balance }} vs last month
                {% else %}
                    No previous data
                {% endif %}
            </div>
        </div>

        <div class="stat-card profit fade-in-up stagger-4">
            <div class="stat-header">
                <div class="stat-icon profit">
                    <i class="bi bi-trending-up"></i>
                </div>
                <div class="stat-change positive">
                    <i class="bi bi-arrow-up"></i>
                    {% if total_income and total_expenses and total_income > 0 %}
                        {{ total_income|subtract:total_expenses|divide:total_income|multiply:100|floatformat:1 }}%
                    {% else %}
                        0.0%
                    {% endif %}
                </div>
            </div>
            <div class="stat-value">
                {% if total_income and total_expenses and total_income > 0 %}
                    {{ total_income|subtract:total_expenses|divide:total_income|multiply:100|floatformat:1 }}%
                {% else %}
                    0.0%
                {% endif %}
            </div>
            <div class="stat-label">Savings Rate</div>
            <div class="stat-comparison">
                {% if total_income and total_expenses %}
                    {% if total_income > total_expenses %}Positive{% else %}Negative{% endif %} savings rate
                {% else %}
                    No data available
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 1. Graphical Analysis -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Daily Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Weekly Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="weeklyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card fade-in-up mb-4">
        <div class="card-header">
            <h5 class="mb-0">Monthly Analysis</h5>
        </div>
        <div class="card-body">
            <canvas id="monthlyChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- 2. Expense Deep-Dive -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Highest Expense Categories</h5>
                </div>
                <div class="card-body">
                    <canvas id="expenseCategoryChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Top Spending Areas</h5>
                </div>
                <div class="card-body">
                    {% for category in expense_categories|slice:":5" %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon expense me-3" style="width: 40px; height: 40px; font-size: 1rem;">
                            <i class="bi bi-tag"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">{{ category.category|title }}</div>
                            <small class="text-muted">Category</small>
                        </div>
                        <div class="text-danger fw-bold">₹{{ category.total|floatformat:0 }}</div>
                    </div>
                    {% empty %}
                    <div class="text-muted text-center">No expense categories found</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Category Chart -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Expense Categories (Pie Chart)</h5>
                </div>
                <div class="card-body">
                    <canvas id="pieChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Expense Categories (Bar Chart)</h5>
                </div>
                <div class="card-body">
                    <canvas id="barChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Comparison -->
    <div class="card fade-in-up mb-4">
        <div class="card-header">
            <h5 class="mb-0">Income vs Expense Comparison Over Time</h5>
        </div>
        <div class="card-body">
            <canvas id="comparisonChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- 5. Future Insights -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Expense Analysis & Saving Tips</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="bi bi-lightbulb me-2"></i>Housing Optimization</h6>
                                <p class="mb-2">Your housing costs are 35% of total expenses. Consider:</p>
                                <ul class="mb-0 small">
                                    <li>Negotiating rent renewal</li>
                                    <li>Energy-efficient appliances</li>
                                    <li>Roommate options</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <h6><i class="bi bi-exclamation-triangle me-2"></i>Food Spending Alert</h6>
                                <p class="mb-2">Food expenses increased by 15% this month:</p>
                                <ul class="mb-0 small">
                                    <li>Plan meals in advance</li>
                                    <li>Use grocery lists</li>
                                    <li>Limit dining out</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="alert alert-success">
                                <h6><i class="bi bi-check-circle me-2"></i>Transportation Savings</h6>
                                <p class="mb-2">Great job on transport costs:</p>
                                <ul class="mb-0 small">
                                    <li>Consider carpooling</li>
                                    <li>Public transport options</li>
                                    <li>Regular maintenance</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="alert alert-primary">
                                <h6><i class="bi bi-graph-up me-2"></i>Income Growth</h6>
                                <p class="mb-2">Your income grew by 12.5%:</p>
                                <ul class="mb-0 small">
                                    <li>Freelance opportunities</li>
                                    <li>Skill development</li>
                                    <li>Investment income</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Predictions (ML Insights)</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-6 text-primary">₹22,500</div>
                        <p class="text-muted">Predicted expenses next month</p>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Confidence Level</span>
                            <span>85%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-primary" style="width: 85%"></div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="bi bi-robot me-2"></i>AI Recommendation</h6>
                        <p class="mb-0 small">Based on your spending patterns, you can save ₹2,000 next month by optimizing food and entertainment expenses.</p>
                    </div>
                    
                    <div class="alert alert-success">
                        <h6><i class="bi bi-target me-2"></i>Goal Achievement</h6>
                        <p class="mb-0 small">You're 78% likely to achieve your monthly savings goal of ₹30,000.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Daily Chart
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Income',
                data: [0, 0, 0, 0, 0, 0, 0],
                backgroundColor: '#10B981'
            }, {
                label: 'Expenses',
                data: [1200, 800, 1500, 900, 1100, 1800, 600],
                backgroundColor: '#F97316'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Weekly Chart
    const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
    new Chart(weeklyCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'Income',
                data: [12000, 15000, 18000, 0],
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Expenses',
                data: [8500, 9200, 7800, 4500],
                borderColor: '#F97316',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Monthly Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
                label: 'Income',
                data: [42000, 38000, 45000, 41000, 48000, 52000, 45000, 47000, 43000, 46000, 44000, 45000],
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Expenses',
                data: [18000, 17500, 18730, 17200, 19500, 21000, 18730, 19200, 18400, 18900, 18600, 18730],
                borderColor: '#F97316',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Expense Category Chart
    const expenseCategoryCtx = document.getElementById('expenseCategoryChart').getContext('2d');
    const expenseCategories = {{ expense_categories_json|safe }};
    
    new Chart(expenseCategoryCtx, {
        type: 'bar',
        data: {
            labels: expenseCategories.map(item => item.category),
            datasets: [{
                label: 'Amount (₹)',
                data: expenseCategories.map(item => parseFloat(item.total)),
                backgroundColor: [
                    '#EF4444',
                    '#F97316',
                    '#8B5CF6',
                    '#F59E0B',
                    '#06B6D4'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Pie Chart
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: expenseCategories.map(item => item.category),
            datasets: [{
                data: expenseCategories.map(item => parseFloat(item.total)),
                backgroundColor: [
                    '#EF4444',
                    '#F97316',
                    '#8B5CF6',
                    '#F59E0B',
                    '#06B6D4'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // Bar Chart
    const barCtx = document.getElementById('barChart').getContext('2d');
    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: expenseCategories.map(item => item.category),
            datasets: [{
                label: 'Amount (₹)',
                data: expenseCategories.map(item => parseFloat(item.total)),
                backgroundColor: [
                    '#EF4444',
                    '#F97316',
                    '#8B6CF6',
                    '#F59E0B',
                    '#06B6D4'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true
                }
            }
        }
    });

    // Comparison Chart
    const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
    new Chart(comparisonCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
                label: 'Income',
                data: [42000, 38000, 45000, 41000, 48000, 52000, 45000, 47000, 43000, 46000, 44000, 45000],
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Expenses',
                data: [18000, 17500, 18730, 17200, 19500, 21000, 18730, 19200, 18400, 18900, 18600, 18730],
                borderColor: '#F97316',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
});
</script>
{% endblock %}