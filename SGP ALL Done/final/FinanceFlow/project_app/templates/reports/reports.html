{% extends '../base.html' %}
{% load math_filters %}

{% block title %}Reports - Finance Flow{% endblock %}

{% block extra_css %}
<style>
    .export-options-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .export-options-card .form-control {
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 10px 12px;
        font-size: 14px;
        background-color: white;
    }
    
    .export-options-card .form-control[readonly] {
        background-color: #f8f9fa;
        color: #495057;
    }
    
    .export-options-card .form-control[style*="border: 1px solid #10b981"] {
        border-color: #10b981 !important;
        background-color: white;
        color: #10b981;
        font-weight: 500;
    }
    
    .generate-report-btn {
        background: linear-gradient(135deg, #10b981, #f59e0b) !important;
        border: none !important;
        color: white !important;
        border-radius: 12px !important;
        padding: 12px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
    }
    
    .generate-report-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
    }
    
    .generate-report-btn i {
        margin-right: 8px;
    }
    
    .export-options-card .form-select {
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 10px 12px;
        font-size: 14px;
        background-color: white;
        transition: all 0.3s ease;
    }
    
    .export-options-card .form-select:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
    }
    
    .export-options-card .form-select[name="format"] {
        border-color: #10b981;
        color: #10b981;
        font-weight: 500;
    }
    
    .alert {
        border-radius: 12px;
        border: none;
        padding: 16px;
        font-size: 14px;
    }
    
    .alert-success {
        background-color: #F0FDF4;
        color: #16A34A;
        border-left: 4px solid #16A34A;
    }
    
    .alert-danger {
        background-color: #FEF2F2;
        color: #DC2626;
        border-left: 4px solid #DC2626;
    }
    
    .alert-warning {
        background-color: #FFFBEB;
        color: #D97706;
        border-left: 4px solid #D97706;
    }
    
    /* Header tools positioning */
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-left: auto;
        padding-left: 20px;
    }
    
    .search-btn, .notification-btn {
        background: rgba(0, 123, 255, 0.1);
        border: 1px solid rgba(0, 123, 255, 0.2);
        border-radius: 8px;
        padding: 8px 12px;
        color: #007bff;
        transition: all 0.3s ease;
    }
    
    .search-btn:hover, .notification-btn:hover {
        background: rgba(0, 123, 255, 0.2);
        border-color: rgba(0, 123, 255, 0.4);
        transform: translateY(-2px);
    }
    
    @media (max-width: 768px) {
        .header-actions {
            padding-right: 12px !important;
            gap: 12px;
        }
        
        .user-name {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Content Header -->
<div class="content-header">
    <h1 class="page-title">Financial Reports</h1>
    <div class="header-actions" style="margin-left: auto; padding-right: 24px;">
        <button class="search-btn" title="Search">
            <i class="bi bi-search"></i>
        </button>
        <button class="notification-btn" title="Notifications">
            <i class="bi bi-bell"></i>
        </button>
        <div class="user-profile dropdown">
            <div class="user-info" data-bs-toggle="dropdown" aria-expanded="false" style="cursor: pointer;">
                <div class="user-avatar">{{ user.name|first|upper }}</div>
                <div class="user-name">{{ user.name }}</div>
                <i class="bi bi-chevron-down ms-2"></i>
            </div>
            <ul class="dropdown-menu dropdown-menu-end" style="z-index: 9999; min-width: 180px; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);">
                <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="bi bi-person me-2"></i>Profile</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Content Body -->
<div class="content-body">
    <!-- Success/Error Messages -->
    {% if message %}
    <div class="alert alert-{{ message_type }} alert-dismissible fade show mb-4" role="alert">
        <i class="bi bi-{% if message_type == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <!-- 1. Export Options -->
    <div class="card mb-4 fade-in-up export-options-card">
        <div class="card-header">
            <h5 class="mb-0">Export Options</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'generate_report' %}">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Report Type</label>
                        <select name="report_type" class="form-select">
                            <option value="Income Report" selected>Income Report</option>
                            <option value="Expense Report">Expense Report</option>
                            <option value="Balance Report">Balance Report</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date Range</label>
                        <select name="date_range" class="form-select">
                            <option value="Last 7 days" selected>Last 7 days</option>
                            <option value="Last 30 days">Last 30 days</option>
                            <option value="Last 3 months">Last 3 months</option>
                            <option value="Last 6 months">Last 6 months</option>
                            <option value="Last year">Last year</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Format</label>
                        <select name="format" class="form-select" style="border: 1px solid #10b981;">
                            <option value="CSV" selected>ðŸ“Š CSV</option>
                            <option value="PDF">ðŸ“„ PDF</option>
                            <option value="Excel">ðŸ“ˆ Excel</option>
                            <option value="JSON">ðŸ”— JSON</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn generate-report-btn">
                                <i class="bi bi-file-earmark-text"></i>
                                Generate Report
                            </button>
                            <!-- Preview removed in old reports page -->
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Enhanced KPI Cards with Tooltips -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stats-card" data-bs-toggle="tooltip" data-bs-placement="top" title="Your total income has increased by â‚¹2,500 since last month. Great progress!">
                <div class="stat-icon income-icon">
                    <i class="bi bi-graph-up"></i>
                </div>
                <div class="stat-value">â‚¹{{ total_income|default:"0" }}</div>
                <div class="stat-label">Total Income</div>
                <div class="d-flex align-items-center mt-2">
                    <span class="badge bg-success me-2">
                        <i class="bi bi-arrow-up me-1"></i>
                        {% if total_income and previous_income and previous_income > 0 %}
                            {{ total_income|percentage_change:previous_income|floatformat:1 }}%
                        {% else %}
                            New
                        {% endif %}
                    </span>
                    <small class="text-muted">vs last period</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="stats-card" data-bs-toggle="tooltip" data-bs-placement="top" title="Your expenses decreased by â‚¹1,150 compared to last month. Good cost control!">
                <div class="stat-icon expense-icon">
                    <i class="bi bi-graph-down"></i>
                </div>
                <div class="stat-value">â‚¹{{ total_expenses|default:"0" }}</div>
                <div class="stat-label">Total Expenses</div>
                <div class="d-flex align-items-center mt-2">
                    <span class="badge bg-warning me-2">
                        <i class="bi bi-arrow-down me-1"></i>
                        {% if total_expenses and previous_expenses and previous_expenses > 0 %}
                            {{ total_expenses|percentage_change:previous_expenses|floatformat:1 }}%
                        {% else %}
                            New
                        {% endif %}
                    </span>
                    <small class="text-muted">vs last period</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="stats-card" data-bs-toggle="tooltip" data-bs-placement="top" title="Net savings change compared to the previous 30 days.">
                <div class="stat-icon balance-icon">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div class="stat-value">â‚¹{{ balance|default:"0" }}</div>
                <div class="stat-label">Net Savings</div>
                <div class="d-flex align-items-center mt-2">
                    {% with ch=balance_change_percent_report|default:0 %}
                    <span class="badge {% if ch >= 0 %}bg-success{% else %}bg-danger{% endif %} me-2">
                        <i class="bi bi-arrow-{% if ch >= 0 %}up{% else %}down{% endif %} me-1"></i>
                        {% if ch >= 0 %}+{% endif %}{{ ch|floatformat:1 }}%
                    </span>
                    {% endwith %}
                    <small class="text-muted">vs last period</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="stats-card" data-bs-toggle="tooltip" data-bs-placement="top" title="Savings rate over the last 30 days and change vs the previous 30 days.">
                <div class="stat-icon savings-icon">
                    <i class="bi bi-trending-up"></i>
                </div>
                <div class="stat-value">{{ savings_rate_report|default:0|floatformat:1 }}%</div>
                <div class="stat-label">Savings Rate</div>
                <div class="d-flex align-items-center mt-2">
                    {% with ch=savings_rate_change_report|default:0 %}
                    <span class="badge {% if ch >= 0 %}bg-info{% else %}bg-danger{% endif %} me-2">
                        <i class="bi bi-percent me-1"></i>
                        {% if ch >= 0 %}+{% endif %}{{ ch|floatformat:1 }}%
                    </span>
                    {% endwith %}
                    <small class="text-muted">vs last period</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Detailed Report -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Income Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon income me-3" style="width: 48px; height: 48px; font-size: 1.25rem;">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">Monthly Income Summary</div>
                            <small class="text-muted">Detailed breakdown of all income sources</small>
                        </div>
                        <div class="btn-group" role="group">
                            <a class="btn btn-outline-success btn-sm" href="{% url 'analytics' %}">
                                <i class="bi bi-eye"></i>
                                View Online
                            </a>
                            <button type="button" class="btn btn-success btn-sm download-report" data-report-type="Income Report">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon profit me-3" style="width: 48px; height: 48px; font-size: 1.25rem;">
                            <i class="bi bi-pie-chart"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">Income by Category</div>
                            <small class="text-muted">Visual representation of income distribution</small>
                        </div>
                        <div class="btn-group" role="group">
                            <a class="btn btn-outline-success btn-sm" href="{% url 'analytics' %}">
                                <i class="bi bi-eye"></i>
                                View Online
                            </a>
                            <button type="button" class="btn btn-success btn-sm download-report" data-report-type="Income Report">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon balance me-3" style="width: 48px; height: 48px; font-size: 1.25rem;">
                            <i class="bi bi-graph-up"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">Income Trends</div>
                            <small class="text-muted">Historical income analysis and forecasting</small>
                        </div>
                        <div class="btn-group" role="group">
                            <a class="btn btn-outline-success btn-sm" href="{% url 'analytics' %}">
                                <i class="bi bi-eye"></i>
                                View Online
                            </a>
                            <button type="button" class="btn btn-success btn-sm download-report" data-report-type="Income Report">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">Expense Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon expense me-3" style="width: 48px; height: 48px; font-size: 1.25rem;">
                            <i class="bi bi-dash-circle"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">Monthly Expense Summary</div>
                            <small class="text-muted">Comprehensive expense breakdown</small>
                        </div>
                        <div class="btn-group" role="group">
                            <a class="btn btn-outline-warning btn-sm" href="{% url 'analytics' %}">
                                <i class="bi bi-eye"></i>
                                View Online
                            </a>
                            <button type="button" class="btn btn-warning btn-sm download-report" data-report-type="Expense Report">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon warning me-3" style="width: 48px; height: 48px; font-size: 1.25rem;">
                            <i class="bi bi-pie-chart"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">Expense by Category</div>
                            <small class="text-muted">Category-wise expense analysis</small>
                        </div>
                        <div class="btn-group" role="group">
                            <a class="btn btn-outline-warning btn-sm" href="{% url 'analytics' %}">
                                <i class="bi bi-eye"></i>
                                View Online
                            </a>
                            <button type="button" class="btn btn-warning btn-sm download-report" data-report-type="Expense Report">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon danger me-3" style="width: 48px; height: 48px; font-size: 1.25rem;">
                            <i class="bi bi-graph-down"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">Spending Patterns</div>
                            <small class="text-muted">Identify spending trends and patterns</small>
                        </div>
                        <div class="btn-group" role="group">
                            <a class="btn btn-outline-warning btn-sm" href="{% url 'analytics' %}">
                                <i class="bi bi-eye"></i>
                                View Online
                            </a>
                            <button type="button" class="btn btn-warning btn-sm download-report" data-report-type="Expense Report">
                                <i class="bi bi-download"></i>
                                Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Balance Trends Report -->
    <div class="card fade-in-up mb-4">
        <div class="card-header">
            <h5 class="mb-0">Balance Trends Report</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon balance me-3" style="width: 48px; height: 48px; font-size: 1.25rem;">
                            <i class="bi bi-cash-stack"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">Balance Overview</div>
                            <small class="text-muted">Monthly balance trends and analysis</small>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm download-report" data-report-type="Balance Report">
                            <i class="bi bi-download"></i>
                            Download
                        </button>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon profit me-3" style="width: 48px; height: 48px; font-size: 1.25rem;">
                            <i class="bi bi-trending-up"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">Savings Analysis</div>
                            <small class="text-muted">Savings rate and goal tracking</small>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm download-report" data-report-type="Balance Report">
                            <i class="bi bi-download"></i>
                            Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Custom Reports -->
    <div class="card fade-in-up mb-4">
        <div class="card-header">
            <h5 class="mb-0">Custom Report Generator</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'generate_custom_report' %}">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="start_date" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">End Date</label>
                        <input type="date" name="end_date" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select">
                            <option value="All">All</option>
                            <option value="Food">Food</option>
                            <option value="Transport">Transport</option>
                            <option value="Housing">Housing</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Salary">Salary</option>
                            <option value="Freelance">Freelance</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Type</label>
                        <select name="type" class="form-select">
                            <option value="All">All</option>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i>
                            Generate
                        </button>
                    </div>
                </div>
                
                <div class="row g-3 mt-3">
                    <div class="col-md-3">
                        <label class="form-label">Amount Range</label>
                        <select name="amount_range" class="form-select">
                            <option value="All">All Amounts</option>
                            <option value="0-1000">â‚¹0 - â‚¹1,000</option>
                            <option value="1000-5000">â‚¹1,000 - â‚¹5,000</option>
                            <option value="5000-10000">â‚¹5,000 - â‚¹10,000</option>
                            <option value="10000+">â‚¹10,000+</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Sort By</label>
                        <select name="sort_by" class="form-select">
                            <option value="date_desc">Date (Newest)</option>
                            <option value="date_asc">Date (Oldest)</option>
                            <option value="amount_desc">Amount (High to Low)</option>
                            <option value="amount_asc">Amount (Low to High)</option>
                            <option value="category">Category</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Group By</label>
                        <select name="group_by" class="form-select">
                            <option value="None">None</option>
                            <option value="Category">Category</option>
                            <option value="Date">Date</option>
                            <option value="Type">Type</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Export Format</label>
                        <select name="export_format" class="form-select">
                            <option value="PDF">ðŸ“„ PDF</option>
                            <option value="Excel">ðŸ“ˆ Excel</option>
                            <option value="CSV">ðŸ“Š CSV</option>
                            <option value="JSON">ðŸ”— JSON</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Recent Reports -->
    <div class="card fade-in-up">
        <div class="card-header">
            <h5 class="mb-0">Recent Reports</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Report Name</th>
                            <th>Type</th>
                            <th>Generated</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_reports %}
                            {% for r in recent_reports %}
                            <tr class="slide-in-left stagger-{{ forloop.counter }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="stat-icon {% if r.type == 'Income' %}income{% elif r.type == 'Expense' %}expense{% elif r.type == 'Balance' %}balance{% else %}profit{% endif %} me-3" style="width: 32px; height: 32px; font-size: 0.875rem;">
                                            <i class="bi bi-file-earmark-text"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">{{ r.name }}</div>
                                            <small class="text-muted">Recent {{ r.type|lower }} summary</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge {% if r.type == 'Income' %}bg-success{% elif r.type == 'Expense' %}bg-warning{% elif r.type == 'Balance' %}bg-primary{% else %}bg-info{% endif %}">{{ r.type }}</span>
                                </td>
                                <td>{{ r.generated }}</td>
                                <td>{{ r.size_display }}</td>
                                <td>
                                    <a class="btn btn-primary btn-sm me-2" href="{% url 'analytics' %}">
                                        <i class="bi bi-eye"></i>
                                        View
                                    </a>
                                    <button type="button" class="btn btn-success btn-sm download-report" data-report-type="{{ r.type }} Report">
                                        <i class="bi bi-download"></i>
                                        Download
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-muted text-center">No reports available yet</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
    (function(){
        const exportForm = document.querySelector('form[action="{% url "generate_report" %}"]');
        const downloadBtns = document.querySelectorAll('.download-report');
        function navigateGenerate(reportType){
            const dateSel = exportForm ? exportForm.querySelector('select[name="date_range"]') : null;
            const fmtSel = exportForm ? exportForm.querySelector('select[name="format"]') : null;
            const base = '{% url "generate_report" %}';
            const url = new URL(base, window.location.origin);
            url.searchParams.set('report_type', reportType || 'Income Report');
            url.searchParams.set('date_range', dateSel ? dateSel.value : 'Last 7 days');
            url.searchParams.set('format', fmtSel ? fmtSel.value : 'CSV');
            window.location.href = url.toString();
        }
        downloadBtns.forEach(btn=>{
            btn.addEventListener('click', function(e){
                if (e && e.preventDefault) e.preventDefault();
                const type = this.getAttribute('data-report-type') || 'Income Report';
                navigateGenerate(type);
            });
        });
    })();
    </script>
</div>
{% endblock %}